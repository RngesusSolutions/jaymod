name: Jaymod Build

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ['', 'debug', 'release']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc \
          g++ \
          gcc-multilib \
          g++-multilib \
          libc6-dev-i386 \
          make \
          python3 \
          m4 \
          coreutils \
          zip \
          tar \
          rsync

    - name: Build Jaymod ${{ matrix.variant }}
      run: |
        if [ -z "${{ matrix.variant }}" ]; then
          echo "Building default variant..."
          make clean
          make 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' all
        else
          echo "Building ${{ matrix.variant }} variant..."
          make VARIANT=${{ matrix.variant }} clean
          make VARIANT=${{ matrix.variant }} 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' all
        fi

    - name: Create package
      run: |
        if [ -z "${{ matrix.variant }}" ]; then
          make 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' pkg || echo "Package creation failed or not applicable"
        else
          make VARIANT=${{ matrix.variant }} 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' pkg || echo "Package creation failed or not applicable"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jaymod-linux-${{ matrix.variant || 'default' }}
        path: |
          build*/
          !build*/**/*.o
          !build*/**/*.d
        retention-days: 30

  build-windows-32bit:
    name: Build Windows 32-bit (MinGW cross-compile)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ['', 'release']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc \
          g++ \
          gcc-multilib \
          g++-multilib \
          libc6-dev-i386 \
          gcc-mingw-w64-i686 \
          g++-mingw-w64-i686 \
          mingw-w64-tools \
          make \
          python3 \
          m4 \
          coreutils \
          zip \
          tar \
          rsync

    - name: Setup MinGW environment
      run: |
        # Create a directory structure that matches what the build system expects
        sudo mkdir -p /opt/mingw32/bin
        sudo ln -sf /usr/bin/i686-w64-mingw32-gcc /opt/mingw32/bin/gcc
        sudo ln -sf /usr/bin/i686-w64-mingw32-g++ /opt/mingw32/bin/g++
        sudo ln -sf /usr/bin/i686-w64-mingw32-ar /opt/mingw32/bin/ar
        sudo ln -sf /usr/bin/i686-w64-mingw32-ranlib /opt/mingw32/bin/ranlib
        sudo ln -sf /usr/bin/i686-w64-mingw32-windres /opt/mingw32/bin/windres

        # Verify the setup
        echo "MinGW 32-bit compiler version:"
        i686-w64-mingw32-g++ --version

    - name: Build Jaymod for Windows 32-bit (MinGW)
      run: |
        if [ -z "${{ matrix.variant }}" ]; then
          echo "Building Windows 32-bit default variant via MinGW..."
          make PLATFORM=mingw GCC/=/opt/mingw32/ clean
          make PLATFORM=mingw GCC/=/opt/mingw32/ 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' all
        else
          echo "Building Windows 32-bit ${{ matrix.variant }} variant via MinGW..."
          make PLATFORM=mingw VARIANT=${{ matrix.variant }} GCC/=/opt/mingw32/ clean
          make PLATFORM=mingw VARIANT=${{ matrix.variant }} GCC/=/opt/mingw32/ 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' all
        fi

    - name: Create package
      run: |
        if [ -z "${{ matrix.variant }}" ]; then
          make PLATFORM=mingw GCC/=/opt/mingw32/ 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' pkg || echo "Package creation failed or not applicable"
        else
          make PLATFORM=mingw VARIANT=${{ matrix.variant }} GCC/=/opt/mingw32/ 'CXX.opt.std=-fno-exceptions -fno-rtti -std=gnu++03' pkg || echo "Package creation failed or not applicable"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jaymod-windows-32bit-${{ matrix.variant || 'default' }}
        path: |
          build*/
          !build*/**/*.o
          !build*/**/*.d
        retention-days: 30
